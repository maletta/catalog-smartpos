image: netpos/node-aws
options:
  max-time: 10

pipelines:
  default:
    - step:
        caches:
          - node
        name: ðŸ”¨ Build
        script:
          - yarn install
          - yarn build
    - step:
        caches:
          - node
        name: âœ¨ Lint
        script:
          - yarn install
          - yarn lint
    - step:
        caches:
          - node
        name: âœ” Cypress
        image: cypress/base:10
        script:
          - yarn install
          - export REACT_APP_GET_NAME_DOMAIN=false
          - export REACT_APP_MAIN_API=https://slip.qa.smartpos.net.br/catalog
          - unset NODE_OPTIONS
          - curl https://slip.qa.smartpos.net.br/catalog/v1/loja/cypress-test
          - yarn ci:cy
  branches:
      develop:
        - step:
            caches:
              - node
            name: âœ¨ Lint
            script:
              - yarn install
              - yarn lint
        - step:
            caches:
              - node
            name: ðŸš€ Deploy development environment
            deployment: test
            script:
              - yarn install
              - yarn build
              - aws s3 sync --delete build s3://$S3_BUCKET
              - aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DISTRIBUTION_ID --paths "/*"
      master:
        - step:
            caches:
              - node
            name: ðŸš€ Deploy production environment
            deployment: production
            script:
              - yarn install
              - yarn build
              - aws s3 sync --delete build s3://$S3_BUCKET
              - aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DISTRIBUTION_ID --paths "/*"

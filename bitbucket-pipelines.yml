image: netpos/node-aws

pipelines:
  default:
    - step:
        caches:
          - node
        name: ðŸ”¨ Build
        script:
          - yarn install
          - yarn build
    - step:
        caches:
          - node
        name: âœ¨ Lint
        script:
          - yarn install
          - yarn lint
    - step:
        caches:
          - node
        name: âœ” Cypress
        image: cypress/base:10
        script:
          - yarn install
          - yarn build
          - yarn http-server build --port 3000 & yarn wait-on http://localhost:3000
          - yarn cypress:run
  branches:
      develop:
        - step:
            caches:
              - node
            name: âœ¨ Lint
            script:
              - yarn install
              - yarn lint
        - step:
            caches:
              - node
            name: ðŸš€ Deploy development environment
            deployment: test
            script:
              - yarn install
              - yarn build
              - aws s3 sync --delete build s3://$S3_BUCKET
              - aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DISTRIBUTION_ID --paths "/*"
      master:
        - step:
            caches:
              - node
            name: ðŸš€ Deploy production environment
            deployment: production
            script:
              - yarn install
              - yarn build
              - aws s3 sync --delete build s3://$S3_BUCKET
              - aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DISTRIBUTION_ID --paths "/*"
